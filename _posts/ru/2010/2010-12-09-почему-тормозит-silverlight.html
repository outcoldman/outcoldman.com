---
layout: post
title: "Почему тормозит Silverlight?"
date: 2010-12-09 13:56:53
categories: ru
tags: [Silverlight, WPF]
redirect_from:
    - ru/blog/show/261/
    - ru/archive/2010/12/09/почему-тормозит-silverlight-/
---
<p>Такой вопрос “Почему тормозит Silverlight?” достаточно часто можно услышать, особенно если вы разрабатываете решения при помощи технологии Silverlight. Часто вы не можете выиграть тендер, или уговорить заказчика на использование технологии Silverlight в вашем приложении, только потому что за ним уже закрепилась эта популярность мышления, что все приложения на Silverlight тормозят. Давайте попробуем обсудить этот вопрос. </p>    <h2>Пример с SQL.RU</h2>  <p>Недавно я начал посматривать на сообщения в ветке <a href="http://sql.ru/forum/actualtopics.aspx?bid=35">WPF, Silverlight</a> форума <a href="http://sql.ru">http://sql.ru</a>, там дал рекомендацию об использовании Фреймворков MVVM (моя позиция <a href="/ru/blog/show/211">известна</a>), и напоролся на такой вот <a href="http://www.sql.ru/forum/actualutils.aspx?action=gotomsg&amp;tid=809980&amp;msg=9902412">вопрос</a>:</p>  <blockquote>   <p>а не подскажите, чем занимается процессор <a href="http://surfity.com/#/Images">по одной из ссылок </a>с этого сайта, когда я его не трогаю? Предположения какие?</p> </blockquote>  <p><em><font size="2">Отступление: Вообще, впечатления от форума sql.ru пока такие, что в любом треде начинается просто бестолковый флуд о том хорошо Silverlight или нет. </font></em></p>  <p>Так вот, по поводу того самого приложения <a href="http://surfity.com/#/Images">http://surfity.com/#/Images</a>. Действительно, если там набрать что-то в поиске, а затем нажать на кнопку Search то после самого поиска можно обнаружить такую картину:</p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto; padding-top: 0px" title="Capture" border="0" alt="Capture" src="{{ site.url }}/library/2010/12/09/Capture_60A5D7EB.png" width="896" height="454" /></p>  <p>В время простоя приложение продолжает использовать процессор почти на полную. Чем-то занимается в бэкграунде. Понятное дело, что все немного подтормаживает от такого упорства приложения. Я не могу дать ответ почему именно в этом случае такая проблема. Но один раз я решал подобный баг, созданный не мной, но который может допустить любой разработчик. </p>  <h2>Пример нашей команды</h2>  <p>Идея была простая. Был график, который рисовался при помощи Syncfusion контролов (мои <a href="/ru/blog/show/256">любимые контролы</a>, на этот раз ошибка была наша). Задача была отобразить линию (типа Target Line: красная линия, которая обозначала где “хорошо” превращается в “плохо”) на обычном Column графике. Примерно это выглядело так:</p>  <p><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; margin-left: auto; border-left-width: 0px; margin-right: auto; padding-top: 0px" title="Capture2" border="0" alt="Capture2" src="{{ site.url }}/library/2010/12/09/Capture2_11C5128C.png" width="608" height="307" /></p>  <p>Контрол Chart, в этом случае, сам рассчитывает необходимую ему градацию для осей координат, и в зависимости от того, какие максимальные и минимальные значения присутствуют в коллекции значений, расставляет максимум и минимум на осях. На картинке это примерно от 70 до 80. Дальше разработчик, например, знает что Target Line это 78 – должен посмотреть есть ли на оси ординат такое значение, и если есть, нарисовать линию. Очевидно, что ему нужно какое-то событие от контрола Chart, вроде “График построился и готов”, чтобы он мог определить где рисовать линию, но такого события нет. Один из вариантов: подписаться на событие LayoutUpdated, который вызовется после того, как график нарисуется: </p>  <pre><code>public partial class MainPage : UserControl
{    public MainPage()
    {
        InitializeComponent();        Chart.LayoutUpdated += new EventHandler(Chart_LayoutUpdated);
    }
&#160;    void Chart_LayoutUpdated(object sender, EventArgs e)
    {        // Draw line... 
    }
}
</code></pre>

<p>А в методе Chart_LayoutUpdated уже добавить линию в контрол Chart. Вроде все просто. После реализации проверяем – все отлично работает. Отправляем исходный код в TFS. Видите проблему? Думаю, не многие сразу ее смогут заметить.</p>

<p>После долгих тестирований, человек, который принимает приложение, говорит: “Все хорошо, но приложение подтормаживает в целом, нельзя ли как-то сделать пошустрее этот ваш Silverlight?”. Понятное дело, что у вас готов стандартный ответ, вроде “Это бизнес приложение, а не записная книжка, понятное дело, что оно подтормаживает, потому что работает.” Но это не в моем случае, я обожаю решать perfomance задачи, еще со времен разработки на C++, когда делали приложение, которое рисовало чертежи, и когда приложение собранное под Debug вместо 40 секунд начинало рисовать чертежи за 10 (в Release за секунду), то я испытывал настоящий кайф. Потому я ответил, что попробую посмотреть что можно сделать. Первым делом открыл приложение и начал долго и упорно с ним работать, утечек памяти серьезных не видел, как ело от 150 до 200 Мб, так и продолжало держаться в этих рамках. Но заметил, что если ничего не делать, то приложение все равно на одном из экранов продолжает есть по 30-40% процессора, хотя на остальных по 5%. Хорошо, что у меня было приложение <a href="http://firstfloorsoftware.com/silverlightspy/download-silverlight-spy/">Silverlight Spy</a>, при помощи которого я и начал анализировать наше приложение и увидел в Event Monitor, что на этом самом проблемном экране циклично и постоянно вызывается event LayoutUpdated. Тогда я и познакомился с этим кодом и с этой проблемой. Конечно, после того как график нарисовался и вызвалось событие LayoutUpdated, мы добавляем еще элемент в контрол, и разумеется вызывается опять тот же event LayoutUpdated и так по кругу. </p>

<p>Вот скажите, как часто вы тестируете свои приложения на то, что оно может работать долго? Как часто вы открываете даже простой Task Manager чтобы посмотреть как ведет себя ваше приложение?</p>

<h2>Выводы</h2>

<p>Очевидно, что отчасти тормознутой эту платформу сделали мы сами, разработчики. Команда разработки Silverlight тоже имеет множество косяков со своей стороны, можно посмотреть только сколько <a href="http://davybrion.com/blog/2010/08/silverlight-getting-worse-when-it-comes-to-memory-leaks/">memory leak находили</a> в самом ядре и базовых контролах Silverlight. Но все же, эти memory leak находят, и настоящие Silverlight разработчики подходят к этому очень щепетильно, и в итоге выпускают отличные решения. </p>

<p>Итак, почему же тормозят приложения на Silverlight? Потому что эта технология позволяет писать веб-приложения любым разработчикам от начинающих до гуру: дружелюбная среда разработки, уж очень простой язык разработки, огромное количество справочных материалов. Можно ли взять начинающего разработчика и попросить его сделать веб-приложение на Html+JavaScript или Flash, чтобы оно работало, было еще и интересным/привлекательным? Я говорю о приложениях для бизнеса, о сайтах-энциклопедий, а не об мелких игрушках и баннерах. Я даю на этот вопрос с уверенностью в 90% ответ “нет”.</p>

<p>Поэтому в будущем, если будете делать упор на разработку решений на Silverlight, учитывайте: </p>

<ul>
  <li>нужно тратить время на изучение поведения приложения; </li>

  <li>в команде нужно иметь одного (число зависит от проекта, конечно же) специалиста, который мог бы решать серьезные проблемы с perfomance, и объяснять народу почему эти проблемы происходят; </li>

  <li>это managed environment, и потому, в пике работы, если с памятью быть не очень аккуратными, то можно загромождать огромные массивы памяти только для временной работы, которые будут освобождены не сразу; </li>
</ul>

<p>И давайте создавать поменьше тормознутых приложений <img style="border-bottom-style: none; border-right-style: none; border-top-style: none; border-left-style: none" class="wlEmoticon wlEmoticon-winkingsmile" alt="Winking smile" src="{{ site.url }}/library/2010/12/09/wlEmoticon-winkingsmile_5122C61C.png" />&#160;</p>

<p>P.S. Больше чем уверен, что появятся вопросы: “Покажите нормальное приложение на Silverlight”. Сразу отвечу, что не знаю таких. Наше приложение, в принципе, ведет себя хорошо, заказчики довольны, проблемы с perfomance по мере их возникновения решаем. Показать его не могу, потому что это intranet приложение. </p>
